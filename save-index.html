<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ===== ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ===== -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markable Audio Player</title>
  
  <!-- PWAè¨­å®š -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  
  <!-- ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿ -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ« ===== */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 48px 64px;
      background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* ===== ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« ===== */
    h1 {
      font-weight: 700;
      font-size: 2.5rem;
      margin: 0 0 32px 0;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #00bfff;
      text-shadow: 0 0 12px #00bfff;
    }

    /* ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ ===== */
    .container {
      width: 100%;
      max-width: 800px;
      background: rgba(15, 15, 15, 0.9);
      border-radius: 20px;
      padding: 48px;
      box-shadow: 0 0 40px rgba(0, 191, 255, 0.7);
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    /* ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
    .section {
      display: flex;
      flex-direction: column;
    }

    /* ===== ãƒ©ãƒ™ãƒ« ===== */
    label {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: #a0cfff;
    }

    strong {
      font-size: 1.1rem;
      color: #a0cfff;
      margin-bottom: 12px;
      display: block;
    }

    /* ===== ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› ===== */
    input[type="file"] {
      margin-top: 12px;
      margin-bottom: 24px;
      padding: 12px 16px;
      border-radius: 16px;
      border: 2px solid #00bfff;
      background: #222;
      color: #ccc;
      font-size: 1rem;
      width: 100%;
      cursor: pointer;
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    input[type="file"]:hover {
      background: #333;
      border-color: #00d9ff;
    }

    /* ===== ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º ===== */
    #fileInfo {
      font-size: 0.9rem;
      color: #888;
      margin-top: -16px;
      margin-bottom: 24px;
      font-style: italic;
    }

    /* ===== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ===== */
    audio#audioPlayer {
      width: 100%;
      height: 50px;
      border-radius: 20px;
      outline: none;
      box-shadow: 0 0 30px rgba(0, 191, 255, 0.5);
    }

    /* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— ===== */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      justify-content: center;
    }

    /* ===== ãƒœã‚¿ãƒ³ï¼ˆå…±é€šã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ ===== */
    button {
      position: relative;
      background: linear-gradient(135deg, #007acc, #00bfff);
      border: none;
      border-radius: 28px;
      padding: 18px 28px;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0, 191, 255, 0.7);
      min-width: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.1s ease;
    }

    /* ===== ãƒœã‚¿ãƒ³ï¼šç„¡åŠ¹çŠ¶æ…‹ ===== */
    button:disabled {
      background: #444;
      color: #777;
      box-shadow: none;
      cursor: not-allowed;
    }

    /* ===== ãƒœã‚¿ãƒ³ï¼šãƒ›ãƒãƒ¼çŠ¶æ…‹ ===== */
    button:hover:not(:disabled) {
      background: linear-gradient(135deg, #00bfff, #007acc);
      box-shadow: 0 8px 24px rgba(0, 191, 255, 1);
      transform: translateY(-2px);
    }

    /* ===== ãƒœã‚¿ãƒ³ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ ===== */
    button:active:not(:disabled) {
      transform: translateY(0);
    }

    /* ===== ãƒœã‚¿ãƒ³å†…ã®ã‚¢ã‚¤ã‚³ãƒ³ ===== */
    button .icon {
      font-size: 2.4rem;
      line-height: 1;
      user-select: none;
      margin-bottom: 6px;
    }

    /* ===== ãƒœã‚¿ãƒ³å†…ã®ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ ===== */
    button .label {
      font-size: 0.75rem;
      color: #c0e8ff;
      user-select: none;
      text-transform: lowercase;
      letter-spacing: 0.05em;
    }

    /* ===== ãƒãƒ¼ã‚¯ä¸€è¦§ã‚³ãƒ³ãƒ†ãƒŠ ===== */
    #marksList {
      font-size: 1.1rem;
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    /* ===== ãƒãƒ¼ã‚¯é …ç›®ï¼ˆå€‹åˆ¥ï¼‰ ===== */
    .mark-item {
      background: #004466;
      padding: 10px 18px;
      border-radius: 24px;
      cursor: pointer;
      color: #a0d8ff;
      font-weight: 700;
      box-shadow: 0 0 12px rgba(0, 191, 255, 0.5);
      transition: background 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      min-width: 60px;
      text-align: center;
    }

    /* ===== ãƒãƒ¼ã‚¯é …ç›®ï¼šãƒ›ãƒãƒ¼çŠ¶æ…‹ ===== */
    .mark-item:hover {
      background: #007acc;
      color: #fff;
      box-shadow: 0 0 16px rgba(0, 191, 255, 0.9);
    }

    /* ===== ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ ===== */
    #log {
      font-size: 0.9rem;
      background: rgba(0, 0, 0, 0.75);
      padding: 20px;
      border-radius: 16px;
      max-height: 260px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
      box-shadow: inset 0 0 14px rgba(0, 191, 255, 0.3);
      color: #a0cfff;
      line-height: 1.4;
      font-family: 'Courier New', monospace;
    }

    /* ===== ãƒ­ã‚°ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º ===== */
    #log::-webkit-scrollbar {
      width: 10px;
    }

    #log::-webkit-scrollbar-track {
      background: transparent;
    }

    #log::-webkit-scrollbar-thumb {
      background: #00bfff;
      border-radius: 5px;
    }

    #log::-webkit-scrollbar-thumb:hover {
      background: #00d9ff;
    }

    /* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ ===== */
    @media (max-width: 768px) {
      body {
        padding: 24px 16px;
      }

      h1 {
        font-size: 1.8rem;
        margin-bottom: 24px;
      }

      .container {
        padding: 24px;
        gap: 24px;
      }

      button {
        min-width: 120px;
        padding: 14px 20px;
      }

      button .icon {
        font-size: 1.8rem;
      }

      button .label {
        font-size: 0.7rem;
      }
    }

  </style>

</head>

<body>
  <!-- ===== ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
  <h1>ğŸµ Markable Audio Player</h1>

  <!-- ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ ===== -->
  <div class="container">

    <!-- ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ï¼šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ ===== -->
    <div class="section">
      <label for="audioFile">ğŸ™ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
      <input type="file" id="audioFile" accept="audio/*">
      <div id="fileInfo" class="file-info"></div>
    </div>

    <!-- ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ï¼šã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ===== -->
    <div class="section">
      <audio id="audioPlayer" controls preload="metadata"></audio>
    </div>

    <!-- ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ï¼šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ ===== -->
    <div class="section" id="controls">
      <!-- å†ç”Ÿ/ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ -->
      <button id="playPauseBtn" disabled title="ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚‚æ“ä½œå¯">
        <span class="icon">â–¶</span>
        <span class="label">å†ç”Ÿ</span>
      </button>

      <!-- ãƒãƒ¼ã‚¯è¿½åŠ ãƒœã‚¿ãƒ³ -->
      <button id="markBtn" disabled title="ç¾åœ¨ä½ç½®ã«ãƒãƒ¼ã‚¯ã‚’è¿½åŠ ">
        <span class="icon">â­</span>
        <span class="label">ãƒãƒ¼ã‚¯</span>
      </button>

      <!-- å‰ã®ãƒãƒ¼ã‚¯ã¸ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ -->
      <button id="prevMarkBtn" disabled title="å‰ã®ãƒãƒ¼ã‚¯ã‹å†’é ­ã¸ã‚¸ãƒ£ãƒ³ãƒ—">
        <span class="icon">â¬…</span>
        <span class="label">å‰ã¸</span>
      </button>

      <!-- æ¬¡ã®ãƒãƒ¼ã‚¯ã¸ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ -->
      <button id="nextMarkBtn" disabled title="æ¬¡ã®ãƒãƒ¼ã‚¯ã¸ã‚¸ãƒ£ãƒ³ãƒ—">
        <span class="icon">â¡</span>
        <span class="label">æ¬¡ã¸</span>
      </button>

      <!-- ãƒãƒ¼ã‚¯å‰Šé™¤ãƒœã‚¿ãƒ³ -->
      <button id="deleteMarkBtn" disabled title="ç¾åœ¨ä½ç½®ã®ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤">
        <span class="icon">âŒ</span>
        <span class="label">å‰Šé™¤</span>
      </button>

      <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
      <button id="exportBtn" disabled title="ãƒãƒ¼ã‚¯ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
        <span class="icon">â¬‡</span>
        <span class="label">ä¿å­˜</span>
      </button>

      <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
      <button id="importBtn" disabled title="ä¿å­˜ã—ãŸãƒãƒ¼ã‚¯ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ">
        <span class="icon">â¬†</span>
        <span class="label">èª­è¾¼</span>
      </button>

      <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
      <input type="file" id="importFileInput" accept="application/json" style="display:none;">
    </div>

    <!-- ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³4ï¼šãƒãƒ¼ã‚¯ä¸€è¦§ ===== -->
    <div class="section">
      <strong>ğŸ“ ãƒãƒ¼ã‚¯ä¸€è¦§:</strong>
      <div id="marksList">(ãªã—)</div>
    </div>

    <!-- ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³5ï¼šãƒ­ã‚°è¡¨ç¤º ===== -->
    <div class="section">
      <strong>ğŸ“ ãƒ­ã‚°:</strong>
      <div id="log"></div>
    </div>

  </div>

  <!-- ===== JavaScriptã‚³ãƒ¼ãƒ‰ ===== -->
  <script>
    // ============================================
    // IndexedDBè¨­å®šå®šæ•°
    // ============================================
    // ã“ã‚Œã‚‰ã®å®šæ•°ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åŸºæœ¬è¨­å®šã§ã™
    const DB_NAME = 'audioMarks';        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å
    const DB_VERSION = 1;                 // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    const STORE_NAME = 'marks';           // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢å

    // ============================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ============================================
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ä½¿ç”¨ã™ã‚‹å¤‰æ•°
    let db = null;                        // IndexedDBã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    let currentFile = null;               // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
    let currentFileKey = null;            // ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€æ„ã‚­ãƒ¼
    let currentMarks = [];                // ç¾åœ¨ã®ãƒãƒ¼ã‚¯é…åˆ—

    // ============================================
    // DOMè¦ç´ ã®å–å¾—
    // ============================================
    // HTMLã®è¦ç´ ã‚’å¤‰æ•°ã«ä¿å­˜ï¼ˆåŠ¹ç‡åŒ–ï¼‰
    const audioFileInput = document.getElementById('audioFile');
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const markBtn = document.getElementById('markBtn');
    const prevMarkBtn = document.getElementById('prevMarkBtn');
    const nextMarkBtn = document.getElementById('nextMarkBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const deleteMarkBtn = document.getElementById('deleteMarkBtn');
    const importFileInput = document.getElementById('importFileInput');
    const marksListEl = document.getElementById('marksList');
    const logEl = document.getElementById('log');
    const fileInfoEl = document.getElementById('fileInfo');

    // ============================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ============================================

    /**
     * ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«å‡ºåŠ›
     * @param {string} message - å‡ºåŠ›ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * 
     * ä½¿ç”¨ä¾‹: log('ãƒãƒ¼ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚')
     */
    function log(message) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;  // æœ€æ–°ã®ãƒ­ã‚°ã¾ã§è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    }

    /**
     * ç§’æ•°ã‚’ MM:SS å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
     * @param {number} sec - ç§’æ•°
     * @returns {string} ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ã®æ™‚é–“æ–‡å­—åˆ—
     * 
     * ä½¿ç”¨ä¾‹: formatTime(95) â†’ "1:35"
     */
    function formatTime(sec) {
      const s = Math.floor(sec % 60);
      const m = Math.floor(sec / 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    /**
     * ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹/ç„¡åŠ¹ã«åˆ‡ã‚Šæ›¿ãˆ
     * @param {boolean} enabled - true ã§æœ‰åŠ¹ã€false ã§ç„¡åŠ¹
     * 
     * ä½¿ç”¨ä¾‹: enableControls(true) ã§ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ãŒä½¿ç”¨å¯èƒ½ã«
     */
    function enableControls(enabled) {
      playPauseBtn.disabled = !enabled;
      markBtn.disabled = !enabled;
      prevMarkBtn.disabled = !enabled;
      nextMarkBtn.disabled = !enabled;
      deleteMarkBtn.disabled = !enabled;
      exportBtn.disabled = !enabled;
      importBtn.disabled = !enabled;
    }

    // ============================================
    // IndexedDBæ“ä½œé–¢æ•°
    // ============================================

    /**
     * IndexedDBã‚’åˆæœŸåŒ–
     * @returns {Promise} åˆæœŸåŒ–å®Œäº†æ™‚ã«è§£æ±º
     * 
     * åˆå›å®Ÿè¡Œæ™‚ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ã‚’ä½œæˆ
     */
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ãªå ´åˆ
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'fileKey' });
            log('IndexedDB: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ã‚’ä½œæˆã—ã¾ã—ãŸã€‚');
          }
        };

        // æˆåŠŸæ™‚
        request.onsuccess = (event) => {
          db = event.target.result;
          log('âœ“ IndexedDB ã«æ¥ç¶šã—ã¾ã—ãŸã€‚');
          resolve(db);
        };

        // å¤±æ•—æ™‚
        request.onerror = (event) => {
          log('âœ— IndexedDB ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          reject(event.target.error);
        };
      });
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€æ„ã‚­ãƒ¼ã‚’ç”Ÿæˆ
     * @param {File} file - ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @returns {string} ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ¼
     * 
     * ãƒ•ã‚¡ã‚¤ãƒ«åã€ã‚µã‚¤ã‚ºã€æ›´æ–°æ—¥æ™‚ã‹ã‚‰ä¸€æ„ã®ã‚­ãƒ¼ã‚’ä½œæˆ
     */
    function getFileKey(file) {
      if (!file) return null;
      const name = file.name || 'unknown';
      const size = file.size || 0;
      const lastModified = file.lastModified
        ? new Date(file.lastModified).toISOString()
        : 'unknown';
      return `${name}|${size}|${lastModified}`;
    }

    /**
     * IndexedDBã‹ã‚‰ãƒãƒ¼ã‚¯ã‚’èª­ã¿è¾¼ã¿
     * @param {string} fileKey - ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ¼
     * @returns {Promise} ãƒãƒ¼ã‚¯æƒ…å ±ã‚’å«ã‚€Promise
     * 
     * ä¿å­˜ã•ã‚ŒãŸãƒãƒ¼ã‚¯ãŒç„¡ã„å ´åˆã¯ç©ºã®é…åˆ—ã‚’è¿”ã™
     */
    function loadMarks(fileKey) {
      return new Promise((resolve, reject) => {
        if (!db) {
          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆ
          resolve({ fileKey, marks: [] });
          return;
        }

        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const request = store.get(fileKey);

        request.onsuccess = () => {
          if (request.result) {
            resolve(request.result);
          } else {
            // ãƒãƒ¼ã‚¯ãŒå­˜åœ¨ã—ãªã„å ´åˆ
            resolve({ fileKey, marks: [] });
          }
        };

        request.onerror = () => {
          reject(request.error);
        };
      });
    }

    /**
     * ãƒãƒ¼ã‚¯ã‚’IndexedDBã«ä¿å­˜
     * @param {string} fileKey - ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ¼
     * @param {Array} marks - ãƒãƒ¼ã‚¯é…åˆ—
     * @returns {Promise} ä¿å­˜å®Œäº†æ™‚ã«è§£æ±º
     * 
     * æ—¢å­˜ã®ãƒãƒ¼ã‚¯ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™
     */
    function saveMarks(fileKey, marks) {
      return new Promise((resolve, reject) => {
        if (!db) {
          reject(new Error('DB not initialized'));
          return;
        }

        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const data = { fileKey, marks };
        const request = store.put(data);

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // ============================================
    // UIæ›´æ–°é–¢æ•°
    // ============================================

    /**
     * ãƒãƒ¼ã‚¯ä¸€è¦§ã‚’UIã«åæ˜ 
     * 
     * æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸãƒãƒ¼ã‚¯ã‚’è¡¨ç¤º
     */
    function updateMarksUI() {
      marksListEl.innerHTML = '';

      // ãƒãƒ¼ã‚¯ãŒãªã„å ´åˆ
      if (!currentMarks || currentMarks.length === 0) {
        marksListEl.textContent = '(ãªã—)';
        return;
      }

      // ãƒãƒ¼ã‚¯ã‚’æ™‚é–“é †ã§ã‚½ãƒ¼ãƒˆ
      currentMarks
        .slice()
        .sort((a, b) => a - b)
        .forEach((t) => {
          const span = document.createElement('span');
          span.className = 'mark-item';
          span.textContent = formatTime(t);
          span.title = `${t.toFixed(3)} ç§’ã§ã‚¸ãƒ£ãƒ³ãƒ—`;

          // ã‚¯ãƒªãƒƒã‚¯ã§ãã®ãƒãƒ¼ã‚¯ã¸ã‚¸ãƒ£ãƒ³ãƒ—
          span.addEventListener('click', () => {
            audioPlayer.currentTime = t;
            log(`ğŸ¯ ãƒãƒ¼ã‚¯ã¸ã‚¸ãƒ£ãƒ³ãƒ—: ${formatTime(t)}`);
          });

          marksListEl.appendChild(span);
        });
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’UIã«è¡¨ç¤º
     * 
     * ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã‚µã‚¤ã‚ºã‚’è¡¨ç¤º
     */
    function updateFileInfo() {
      if (!currentFile) {
        fileInfoEl.textContent = '';
        return;
      }

      const size = (currentFile.size / 1024 / 1024).toFixed(2);
      fileInfoEl.textContent = `ğŸ“„ ${currentFile.name} (${size} MB)`;
    }

    // ============================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
    // ============================================
    audioFileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];

      if (!file) {
        enableControls(false);
        return;
      }

      try {
        currentFile = file;
        currentFileKey = getFileKey(file);
        updateFileInfo();

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¨­å®š
        const url = URL.createObjectURL(file);
        audioPlayer.src = url;
        enableControls(true);

        log(`âœ“ ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ: ${file.name}`);

        // ä¿å­˜ã•ã‚ŒãŸãƒãƒ¼ã‚¯ã‚’èª­ã¿è¾¼ã¿
        const data = await loadMarks(currentFileKey);
        currentMarks = data.marks || [];
        updateMarksUI();
        log(`ğŸ”„ ãƒãƒ¼ã‚¯ ${currentMarks.length} å€‹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
      } catch (error) {
        log(`âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        enableControls(false);
      }
    });

    // ============================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼šå†ç”Ÿ/ä¸€æ™‚åœæ­¢
    // ============================================
    playPauseBtn.addEventListener('click', () => {
      if (audioPlayer.paused) {
        audioPlayer.play();
        log('â–¶ å†ç”Ÿé–‹å§‹');
      } else {
        audioPlayer.pause();
        log('â¸ ä¸€æ™‚åœæ­¢');
      }
    });

    // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚‚å†ç”Ÿ/ä¸€æ™‚åœæ­¢
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !playPauseBtn.disabled) {
        e.preventDefault();
        playPauseBtn.click();
      }
    });

    // ============================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼šãƒãƒ¼ã‚¯è¿½åŠ 
    // ============================================
    markBtn.addEventListener('click', async () => {
      const currentTime = audioPlayer.currentTime;

      // æ—¢ã«åŒã˜ä½ç½®ã«ãƒãƒ¼ã‚¯ãŒã‚ã‚‹ã‹ç¢ºèª
      if (currentMarks.includes(currentTime)) {
        log(`âš ï¸ ã“ã®ä½ç½®ã«ã¯æ—¢ã«ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚`);
        return;
      }

      currentMarks.push(currentTime);
      await saveMarks(currentFileKey, currentMarks);
      updateMarksUI();
      log(`â­ ãƒãƒ¼ã‚¯è¿½åŠ : ${formatTime(currentTime)}`);
    });

    // ============================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼šå‰ã®ãƒãƒ¼ã‚¯ã¸ã‚¸ãƒ£ãƒ³ãƒ—
    // ============================================
    prevMarkBtn.addEventListener('click', () => {
      const currentTime = audioPlayer.currentTime;
      
      // ç¾åœ¨ã®æ™‚é–“ã‚ˆã‚Šå‰ã®ãƒãƒ¼ã‚¯ã‚’æ¢ã™
      const prev = currentMarks
        .filter((m) => m < currentTime)
        .sort((a, b) => b - a)[0];

      if (prev !== undefined) {
        audioPlayer.currentTime = prev;
        log(`â¬…ï¸ å‰ã®ãƒãƒ¼ã‚¯ã¸: ${formatTime(prev)}`);
      } else {
        // å‰ã®ãƒãƒ¼ã‚¯ãŒãªã„å ´åˆã¯å†’é ­ã¸
        audioPlayer.currentTime = 0;
        log(`â¬…ï¸ å†’é ­ã¸ç§»å‹•ã—ã¾ã—ãŸã€‚`);
      }
    });

    // ============================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼šæ¬¡ã®ãƒãƒ¼ã‚¯ã¸ã‚¸ãƒ£ãƒ³ãƒ—
    // ============================================
    nextMarkBtn.addEventListener('click', () => {
      const currentTime = audioPlayer.currentTime;
      
      // ç¾åœ¨ã®æ™‚é–“ã‚ˆã‚Šå¾Œã®ãƒãƒ¼ã‚¯ã‚’æ¢ã™
      const next = currentMarks
        .filter((m) => m > currentTime)
        .sort((a, b) => a - b)[0];

      if (next !== undefined) {
        audioPlayer.currentTime = next;
        log(`â¡ï¸ æ¬¡ã®ãƒãƒ¼ã‚¯ã¸: ${formatTime(next)}`);
      } else {
        // æ¬¡ã®ãƒãƒ¼ã‚¯ãŒãªã„å ´åˆ
        log(`âš ï¸ æ¬¡ã®ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
      }
    });

    // ============================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼šãƒãƒ¼ã‚¯å‰Šé™¤
    // ============================================
    deleteMarkBtn.addEventListener('click', async () => {
      const currentTime = audioPlayer.currentTime;
      const index = currentMarks.indexOf(currentTime);

      if (index === -1) {
        log(`âš ï¸ ã“ã®ä½ç½®ã«ã¯ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
        return;
      }

      currentMarks.splice(index, 1);
      await saveMarks(currentFileKey, currentMarks);
      updateMarksUI();
      log(`âŒ ãƒãƒ¼ã‚¯å‰Šé™¤: ${formatTime(currentTime)}`);
    });

    // ============================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    // ============================================
    exportBtn.addEventListener('click', () => {
      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
      const data = {
        fileName: currentFile.name,
        fileSize: currentFile.size,
        marks: currentMarks,
        exportDate: new Date().toISOString(),
      };

      // JSONå½¢å¼ã§å‡ºåŠ›
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
      const a = document.createElement('a');
      a.href = url;
      a.download = `marks_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      log(`â¬‡ï¸ ãƒãƒ¼ã‚¯ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ: ${a.download}`);
    });

    // ============================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    // ============================================
    importBtn.addEventListener('click', () => {
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
      importFileInput.click();
    });

    importFileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        // ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ¤œè¨¼
        if (!Array.isArray(data.marks)) {
          throw new Error('ç„¡åŠ¹ãªãƒãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚');
        }

        // ãƒãƒ¼ã‚¯ã‚’æ›´æ–°
        currentMarks = data.marks;
        await saveMarks(currentFileKey, currentMarks);
        updateMarksUI();
        log(`âœ“ ãƒãƒ¼ã‚¯ ${currentMarks.length} å€‹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
      } catch (e) {
        log(`âœ— ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
      importFileInput.value = '';
    });

    // ============================================
    // Service Workerç™»éŒ²
    // ============================================
    // PWAå¯¾å¿œ: Service Workerã‚’ç™»éŒ²ã—ã¦ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('service-worker.js')
          .then((registration) => {
            log('âœ“ Service Worker ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
          })
          .catch((error) => {
            log(
              `âš ï¸ Service Worker ã®ç™»éŒ²ã«å¤±æ•—: ${error.message}`
            );
          });
      });
    }

    // ============================================
    // åˆæœŸåŒ–å‡¦ç†
    // ============================================
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã®åˆæœŸåŒ–
    openDB()
      .then(() => {
        log('âœ“ IndexedDB åˆæœŸåŒ–å®Œäº†ã€‚');
      })
      .catch(() => {
        log(
          'âš ï¸ IndexedDB ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¯ä¿å­˜ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚'
        );
      });
  </script>

</body>
</html>

