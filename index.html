<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Markable Audio Player</title>
    <style>
        /* ===== Global Styles ===== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background: #001f33; color: #a0d8ff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1 { font-weight: 700; font-size: 1.1rem; margin: 10px 0 20px 0; letter-spacing: 2px; text-transform: uppercase; color: #a0d8ff; }
        .container { width: 100%; max-width: 800px; background: rgba(0, 31, 51, 0.9); border-radius: 20px; padding: 24px; display: flex; flex-direction: column; gap: 30px; }
        .section { display: flex; flex-direction: column; align-items: center; } /* 中央寄せ */
        
        /* カスタムファイル選択ボタン */
        .file-upload-wrapper { position: relative; width: fit-content; margin-bottom: 10px; }
        .custom-file-btn { 
            display: inline-block; padding: 10px 20px; background: transparent; 
            border: 1px solid #66ccff; color: #66ccff; border-radius: 8px; 
            font-size: 0.9rem; font-weight: bold; cursor: pointer;
        }
        #audioFile { 
            position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; 
        }

        #fileInfo { font-size: 0.95rem; color: #7fbfff; margin: 5px 0 15px 0; font-style: italic; border-bottom: 1px solid #335577; padding-bottom: 8px; word-break: break-all; width: 100%; text-align: center; }

        /* Custom Player UI */
        .custom-player { background: #00334d; padding: 25px; border-radius: 24px; display: flex; flex-direction: column; gap: 25px; width: 100%; }
        
        .player-controls-row { display: flex; align-items: center; justify-content: center; gap: 40px; width: 100%; }
        
        .play-pause-btn { background: #66ccff; color: #001f33; border: none; border-radius: 50%; width: 85px; height: 85px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; flex-shrink: 0; }
        .play-pause-btn:active { transform: scale(0.95); }
        .play-pause-btn:disabled { opacity: 0.3; }

        .play-icon { width: 0; height: 0; border-style: solid; border-width: 15px 0 15px 25px; border-color: transparent transparent transparent #001f33; margin-left: 6px; }
        .pause-icon { display: flex; gap: 8px; justify-content: center; align-items: center; }
        .pause-bar { width: 8px; height: 30px; background-color: #001f33; border-radius: 2px; }

        .speed-control { display: flex; flex-direction: column; align-items: flex-start; gap: 8px; color: #a0d8ff; }
        #speedSlider { width: 140px; accent-color: #66ccff; margin: 0; cursor: pointer; }
        .speed-label { font-size: 0.9rem; font-weight: bold; font-family: monospace; }

        .seek-container { display: flex; align-items: center; gap: 15px; width: 100%; }
        #seekBar { flex-grow: 1; height: 12px; accent-color: #66ccff; cursor: pointer; }
        #currentTime, #duration { font-family: monospace; font-size: 1rem; min-width: 50px; }

        #controls { display: flex; flex-direction: row !important; justify-content: center; gap: 20px; width: 100%; }
        .action-btn { background: transparent; border: none; cursor: pointer; color: #66ccff; display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 80px; flex: 1; }
        .action-btn:disabled { opacity: 0.2; }
        .action-btn .icon { font-size: 3rem; line-height: 1; }
        .action-btn .label { font-size: 0.8rem; text-transform: lowercase; font-weight: bold; }

        #marksList { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px; width: 100%; justify-content: center; }
        .mark-item { border: 2px solid #66ccff; padding: 12px 20px; border-radius: 30px; color: #66ccff; font-weight: bold; font-size: 1.1rem; cursor: pointer; }

        #log { font-size: 0.85rem; background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 12px; height: 110px; overflow-y: auto; font-family: monospace; border: 1px solid #00334d; white-space: pre-wrap; width: 100%; }
        #exportImport { text-align: center; margin-top: 15px; color: #66ccff; }
        #exportImport a { color: #66ccff; text-decoration: none; margin: 0 12px; font-size: 0.9rem; cursor: pointer; }
    </style>
</head>
<body>

<h1>MARKABLE AUDIO PLAYER</h1>

<div class="container">
    <div class="section">
        <div class="file-upload-wrapper">
            <div class="custom-file-btn">SELECT FILE</div>
            <input type="file" id="audioFile" accept="audio/*">
        </div>
        <div id="fileInfo">no file selected</div>
    </div>

    <div class="custom-player">
        <div class="player-controls-row">
            <button class="play-pause-btn" id="playPauseBtn" disabled>
                <div id="btnIcon"><div class="play-icon"></div></div>
            </button>
            <div class="speed-control">
                <span class="speed-label">speed: <span id="speedVal">1.0</span>x</span>
                <input type="range" id="speedSlider" min="0.5" max="4.0" step="0.1" value="1.0" disabled>
            </div>
        </div>
        
        <div class="seek-container">
            <span id="currentTime">0:00</span>
            <input type="range" id="seekBar" value="0" step="0.1" disabled>
            <span id="duration">0:00</span>
        </div>
    </div>

    <div class="section" id="controls">
        <button id="markBtn" class="action-btn" disabled>
            <span class="icon">⚪︎</span>
            <span class="label">mark</span>
        </button>
        <button id="deleteMarkBtn" class="action-btn" disabled>
            <span class="icon">×</span>
            <span class="label">delete</span>
        </button>
        <button id="prevMarkBtn" class="action-btn" disabled>
            <span class="icon">&lt;</span>
            <span class="label">previous</span>
        </button>
    </div>

    <div class="section">
        <label style="font-weight: bold; margin-bottom: 10px;">marks</label>
        <div id="marksList">(none)</div>
    </div>

    <div class="section">
        <div id="log"></div>
        <div id="exportImport">
            <a id="exportBtn" style="opacity: 0.3; pointer-events: none;">export</a> │ 
            <a id="importBtn" style="opacity: 0.3; pointer-events: none;">import</a>
        </div>
    </div>
</div>

<audio id="audioElement"></audio>
<input type="file" id="importFileInput" accept="application/json" style="display:none;">

<script>
const DB_NAME = 'audioMarks_v2'; 
const STORE_NAME = 'marks';
let db, currentFileKey;
let currentMarks = [];

const audio = document.getElementById('audioElement');
const playPauseBtn = document.getElementById('playPauseBtn');
const btnIconContainer = document.getElementById('btnIcon');
const seekBar = document.getElementById('seekBar');
const speedSlider = document.getElementById('speedSlider');
const speedVal = document.getElementById('speedVal');
const logEl = document.getElementById('log');

// DB Setup
const req = indexedDB.open(DB_NAME, 1);
req.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE_NAME, { keyPath: 'fileKey' });
req.onsuccess = (e) => { db = e.target.result; log("✓ system ready."); };

function log(msg) {
    const time = new Date().toLocaleTimeString();
    logEl.textContent += `[${time}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
}

function formatTime(sec) {
    if (isNaN(sec)) return "0:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
}

function updatePlayBtnUI() {
    if (audio.paused) {
        btnIconContainer.innerHTML = '<div class="play-icon"></div>';
    } else {
        btnIconContainer.innerHTML = '<div class="pause-icon"><div class="pause-bar"></div><div class="pause-bar"></div></div>';
    }
}

async function loadSavedMarks() {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const getReq = store.get(currentFileKey);
    getReq.onsuccess = () => {
        currentMarks = getReq.result ? getReq.result.marks : [];
        updateMarksUI();
        if (currentMarks.length > 0) log(`restored ${currentMarks.length} marks.`);
    };
}

document.getElementById('audioFile').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    currentFileKey = `${file.name}-${file.size}`;
    // ここでデザインしたfileInfoだけに名前を入れる
    document.getElementById('fileInfo').textContent = `playing: ${file.name}`;
    audio.src = URL.createObjectURL(file);
    
    playPauseBtn.disabled = false;
    seekBar.disabled = false;
    speedSlider.disabled = false;
    document.querySelectorAll('.action-btn').forEach(b => b.disabled = false);
    document.getElementById('exportBtn').style = "opacity: 1; pointer-events: auto;";
    document.getElementById('importBtn').style = "opacity: 1; pointer-events: auto;";
    
    log(`file selected: ${file.name}`);
    loadSavedMarks();
};

playPauseBtn.onclick = () => {
    if (audio.paused) audio.play(); else audio.pause();
    updatePlayBtnUI();
};

speedSlider.oninput = () => {
    const val = parseFloat(speedSlider.value);
    audio.playbackRate = val;
    speedVal.textContent = val.toFixed(1);
};

audio.ontimeupdate = () => {
    seekBar.value = (audio.currentTime / audio.duration) * 100 || 0;
    document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
};

audio.onloadedmetadata = () => {
    document.getElementById('duration').textContent = formatTime(audio.duration);
};

seekBar.oninput = () => {
    audio.currentTime = (seekBar.value / 100) * audio.duration;
};

async function save() {
    if (!db || !currentFileKey) return;
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).put({ fileKey: currentFileKey, marks: currentMarks });
}

document.getElementById('markBtn').onclick = () => {
    const t = audio.currentTime;
    if (!currentMarks.some(m => Math.abs(m - t) < 0.3)) {
        currentMarks.push(t);
        save();
        updateMarksUI();
        log(`added mark: ${formatTime(t)}`);
    }
};

document.getElementById('deleteMarkBtn').onclick = () => {
    const t = audio.currentTime;
    const pastMarks = currentMarks.filter(m => m < t - 0.1).sort((a, b) => b - a);
    if (pastMarks.length > 0) {
        const targetMark = pastMarks[0];
        currentMarks.splice(currentMarks.indexOf(targetMark), 1);
        save();
        updateMarksUI();
        log(`deleted mark at ${formatTime(targetMark)}`);
    }
};

document.getElementById('prevMarkBtn').onclick = () => {
    const prev = currentMarks.filter(m => m < audio.currentTime - 1).sort((a,b) => b-a)[0];
    audio.currentTime = prev || 0;
};

function updateMarksUI() {
    const list = document.getElementById('marksList');
    list.innerHTML = '';
    if (currentMarks.length === 0) { list.textContent = '(none)'; return; }
    currentMarks.sort((a,b) => a-b).forEach(t => {
        const item = document.createElement('div');
        item.className = 'mark-item';
        item.textContent = formatTime(t);
        item.onclick = () => audio.currentTime = t;
        list.appendChild(item);
    });
}

document.getElementById('exportBtn').onclick = () => {
    const blob = new Blob([JSON.stringify({ marks: currentMarks })], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `marks_${currentFileKey}.json`;
    a.click();
};

document.getElementById('importBtn').onclick = () => document.getElementById('importFileInput').click();
document.getElementById('importFileInput').onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
        const data = JSON.parse(await file.text());
        currentMarks = data.marks || [];
        save();
        updateMarksUI();
        log("marks imported.");
    } catch(e) { log("error: invalid JSON file."); }
};
</script>
</body>
</html>